<!DOCTYPE html>
<html lang="es">
<head>
  <%- include("partials/head") %>
</head>
<body class="bg-gray-50 min-h-screen pb-24 font-sans text-gray-800">
    <header class="sticky top-0 z-50 border-b border-gray-200 shadow-sm transition-all duration-300 bg-gray-50">
        <div class="max-w-md mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <a 
                  href="/" 
                  aria-label="Ir a pÃ¡gina principal"
                  class="inline-block focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 rounded-xl"
                >
                  <div class="w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/30 hover:bg-indigo-700 transition-colors">
                    <i class="fas fa-motorcycle"></i>
                  </div>
                </a>
                <div>
                    <h1 class="text-lg font-bold leading-tight text-gray-900">Delivery Tracker</h1>
                    <p class="text-xs text-gray-500 font-medium" id="currentDateDisplay"></p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="window.location.href='/route'" class="w-9 h-9 flex items-center justify-center bg-gray-100 rounded-full text-indigo-600 hover:bg-indigo-50 transition">
                    <i class="fas fa-map-marked-alt"></i>
                </button>
                <button onclick="showShiftHistory()" class="w-9 h-9 flex items-center justify-center bg-gray-100 rounded-full text-gray-600 hover:bg-gray-200 transition">
                    <i class="fas fa-history"></i>
                </button>
            </div>
        </div>
    </header>
    <main class="max-w-md mx-auto px-4 pt-4 space-y-6">
        <div id="shiftPanel" class="rounded-2xl overflow-hidden shadow-lg relative transition-all duration-500">
            <div id="shiftLoading" class="bg-white p-6 text-center text-gray-400">
                <i class="fas fa-circle-notch fa-spin"></i>
            </div>
            <div id="shiftInactive" class="hidden bg-gray-900 p-5 text-white flex justify-between items-center">
                <div>
                    <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Estado de Caja</p>
                    <h3 class="font-bold text-lg">Jornada Cerrada</h3>
                </div>
                <button onclick="startShift()" class="bg-emerald-500 hover:bg-emerald-400 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg shadow-emerald-500/20 active:scale-95 transition">
                    <i class="fas fa-power-off mr-2"></i> Iniciar
                </button>
            </div>
            <div id="shiftActive" class="hidden bg-gradient-to-r from-indigo-600 to-purple-700 p-5 text-white relative">
                <div class="absolute top-0 right-0 p-3 opacity-10"><i class="fas fa-wallet text-6xl"></i></div>
                <div class="relative z-10">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider">Total en Caja</p>
                            <h2 class="text-3xl font-bold tracking-tight" id="shiftGrandTotal">$0.00</h2>
                            <p class="text-xs text-indigo-200 mt-1">Base: <span id="shiftBase">$0</span></p>
                        </div>
                        <div class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg">
                            <span class="block w-2 h-2 bg-emerald-400 rounded-full animate-pulse inline-block mr-1"></span>
                            <span class="text-xs font-bold">En vivo</span>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="shareShift()" class="bg-white/10 hover:bg-white/20 py-2 rounded-lg text-sm font-semibold backdrop-blur-sm border border-white/10 transition">
                            <i class="fas fa-share-alt mr-1"></i> Compartir
                        </button>
                        <button onclick="endShift()" class="bg-red-500/80 hover:bg-red-600/90 py-2 rounded-lg text-sm font-semibold backdrop-blur-sm shadow-md transition">
                            <i class="fas fa-stop-circle mr-1"></i> Cerrar
                        </button>
                        <button onclick="addManualDelivery()" class="bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-100 py-2.5 rounded-xl text-sm font-bold backdrop-blur-md border border-emerald-500/30 flex items-center justify-center gap-2 transition">
                            <i class="fas fa-plus-circle"></i> Ingreso Extra
                        </button>
                        <button onclick="addExpense()" class="bg-red-500/20 hover:bg-red-500/30 text-red-100 py-2.5 rounded-xl text-sm font-bold backdrop-blur-md border border-red-500/30 flex items-center justify-center gap-2 transition">
                            <i class="fas fa-minus-circle"></i> Gasto
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="grid grid-cols-3 gap-3">
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center mb-1 text-xs">
                    <i class="fas fa-calendar-day"></i>
                </div>
                <p class="text-[10px] text-gray-400 font-bold uppercase">Hoy</p>
                <p class="text-sm font-bold text-gray-800">$<%= todayTotal %></p>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <div class="w-8 h-8 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center mb-1 text-xs">
                    <i class="fas fa-coins"></i>
                </div>
                <p class="text-[10px] text-gray-400 font-bold uppercase">Total</p>
                <p class="text-sm font-bold text-gray-800">$<%= total %></p>
            </div>
            <div class="bg-white p-3 rounded-2xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <div class="w-8 h-8 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center mb-1 text-xs">
                    <i class="fas fa-box"></i>
                </div>
                <p class="text-[10px] text-gray-400 font-bold uppercase">Entregas</p>
                <p class="text-sm font-bold text-gray-800"><%= pagination.totalDocs %></p>
            </div>
        </div>
        <div class="relative group">
            <div class="absolute -inset-1 bg-gradient-to-r from-indigo-500 to-purple-500 rounded-2xl blur opacity-25 group-hover:opacity-50 transition duration-1000 group-hover:duration-200"></div>
            <div class="relative bg-white rounded-2xl shadow-sm p-1">
                <%- include("partials/cropper") %>
            </div>
        </div>
        <div class="flex gap-2">
            <div class="relative flex-1">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-400 text-sm"></i>
                <input type="text" id="searchInput" placeholder="Buscar factura, cliente..." 
                       value="<%= filters.search || '' %>"
                       class="w-full pl-10 pr-4 py-3 bg-white border-none shadow-sm rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 transition"
                       onkeydown="if(event.key === 'Enter') applyFilters()">
            </div>
            <button onclick="applyFilters()" class="bg-indigo-600 text-white w-12 rounded-xl shadow-lg shadow-indigo-500/20 active:scale-95 transition">
                <i class="fas fa-arrow-right"></i>
            </button>
        </div>
        <div class="space-y-4">
            <div class="flex justify-between items-end px-1">
                <h2 class="text-lg font-bold text-gray-800">Historial</h2>
                <% if (filters.shiftId) { %>
                    <span class="text-xs bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full flex items-center gap-1">
                        Filtro: Jornada <button onclick="clearShiftFilter()" class="ml-1 hover:text-red-500">Ã—</button>
                    </span>
                <% } %>
            </div>
            <div id="deliveriesContainer" class="space-y-3 pb-4 transition-opacity duration-200">
                <% deliveries.forEach(item => { 
                    const isExpense = item.type === 'expense';
                %>
                    <div onclick="<%= isExpense ? `Swal.fire('Gasto', '${item.description}: $${item.amount}', 'info')` : `openDeliveryModal('${item._id}')` %>" 
                         class="bg-white p-4 rounded-2xl shadow-sm border <%= isExpense ? 'border-red-100' : 'border-gray-100' %> flex justify-between items-center active:bg-gray-50 transition cursor-pointer relative overflow-hidden group">
                        <div class="absolute left-0 top-0 bottom-0 w-1.5 <%= isExpense ? 'bg-red-500' : 'bg-indigo-500' %>"></div>
                        <div class="pl-2">
                            <h3 class="font-bold text-gray-800 flex items-center gap-2">
                                <span class="<%= isExpense ? 'text-red-600' : 'text-indigo-600' %>">
                                    <%= isExpense ? 'Gasto' : '#' + item.invoiceNumber %>
                                </span>
                            </h3>
                            <p class="text-sm text-gray-500 mt-1 flex items-center gap-1">
                                <i class="fas <%= isExpense ? 'fa-minus-circle' : 'fa-map-marker-alt' %> text-xs text-gray-400"></i>
                                <%= item.address ? (item.address.substring(0, 25) + (item.address.length > 25 ? '...' : '')) : 'Sin detalle' %>
                            </p>
                        </div>
                        <div class="text-right">
                             <span class="block font-bold <%= isExpense ? 'text-red-500' : 'text-gray-800' %>">
                                <%= isExpense ? '-' : '' %>$<%= item.amount.toLocaleString('es-CO') %>
                            </span>
                            <span class="text-[10px] text-gray-400">
                                <%= new Date(item.date).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                            </span>
                        </div>
                    </div>
                <% }); %>
            </div>
            <div class="flex justify-center items-center gap-4 py-4" id="paginationControls">
                <button id="prevPageBtn" onclick="loadPage(<%= pagination.page - 1 %>)" 
                        <%= pagination.hasPrevPage ? '' : 'disabled' %>
                        class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <span id="pageLabel" class="text-sm font-bold text-gray-500">
                    PÃ¡gina <%= pagination.page %> de <%= pagination.totalPages %>
                </span>
                <button id="nextPageBtn" onclick="loadPage(<%= pagination.page + 1 %>)" 
                        <%= pagination.hasNextPage ? '' : 'disabled' %>
                        class="w-10 h-10 rounded-full bg-white shadow-sm flex items-center justify-center text-gray-600 disabled:opacity-50 disabled:cursor-not-allowed hover:bg-gray-50 transition">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
        <div class="text-center pt-6 pb-4">
            <p class="text-xs text-gray-400">
                Delivery Tracker â€¢ by: MJFOOD
            </p>
        </div>
    </main>
    <script>
        const options = { weekday: 'long', day: 'numeric', month: 'long' };
        document.getElementById('currentDateDisplay').textContent = new Date().toLocaleDateString('es-ES', options);
        window.deliveriesData = <%- JSON.stringify(deliveries).replace(/</g, '\\u003c') %>;
        window.currentFilters = {
            search: "<%= filters.search || '' %>",
            page: <%= pagination.page %>,
            shiftId: "<%= filters.shiftId || '' %>"
        };
    </script>
    <script>
        let waitingWorker = null;
        let updateBanner = null;

        function showUpdateBanner(worker) {
            if (updateBanner) return;
            
            waitingWorker = worker;
            
            updateBanner = document.createElement('div');
            updateBanner.id = 'pwa-update-banner';
            updateBanner.className = 'pwa-update-banner';
            updateBanner.innerHTML = `
                <div class="update-content">
                    <span>ðŸ”„ Â¡Nueva versiÃ³n disponible!</span>
                    <p>Actualiza para obtener las Ãºltimas mejoras.</p>
                </div>
                <div class="update-actions">
                    <button id="update-later" class="btn-text">MÃ¡s tarde</button>
                    <button id="update-now" class="btn-primary">Actualizar</button>
                </div>
            `;
            
            document.body.appendChild(updateBanner);
            
            const style = document.createElement('style');
            style.textContent = `
                .pwa-update-banner {
                    position: fixed;
                    bottom: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    width: min(90%, 400px);
                    background: #2d3748;
                    color: white;
                    padding: 16px 20px;
                    border-radius: 12px;
                    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
                    z-index: 9998;
                    display: flex;
                    flex-direction: column;
                    gap: 12px;
                    animation: slideUp 0.5s ease;
                }
                
                .update-content span {
                    font-weight: 600;
                    font-size: 15px;
                    display: block;
                    margin-bottom: 4px;
                }
                
                .update-content p {
                    margin: 0;
                    font-size: 13px;
                    opacity: 0.9;
                }
                
                .update-actions {
                    display: flex;
                    gap: 10px;
                    justify-content: flex-end;
                }
                
                #update-later, #update-now {
                    padding: 8px 16px;
                    border-radius: 6px;
                    font-size: 13px;
                    font-weight: 600;
                    cursor: pointer;
                    border: none;
                    transition: all 0.2s;
                }
                
                #update-later {
                    background: transparent;
                    color: #a0aec0;
                }
                
                #update-later:hover {
                    background: rgba(255,255,255,0.1);
                }
                
                #update-now {
                    background: #38a169;
                    color: white;
                }
                
                #update-now:hover {
                    background: #2f855a;
                    transform: translateY(-1px);
                }
                
                @keyframes slideUp {
                    from {
                        opacity: 0;
                        transform: translate(-50%, 20px);
                    }
                    to {
                        opacity: 1;
                        transform: translate(-50%, 0);
                    }
                }
            `;
            
            if (!document.querySelector('#update-banner-styles')) {
                style.id = 'update-banner-styles';
                document.head.appendChild(style);
            }
            
            document.getElementById('update-now').addEventListener('click', () => {
                waitingWorker.postMessage({ type: 'SKIP_WAITING' });
                updateBanner.remove();
                updateBanner = null;
            });
            
            document.getElementById('update-later').addEventListener('click', () => {
                updateBanner.remove();
                updateBanner = null;
            });
        }

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', async () => {
                try {
                    const registration = await navigator.serviceWorker.register('/sw.js');
                    //console.log('âœ… Service Worker registrado:', registration.scope);
                    
                    if (registration.waiting) {
                        showUpdateBanner(registration.waiting);
                    }
                    
                    registration.addEventListener('updatefound', () => {
                        const newWorker = registration.installing;
                        newWorker.addEventListener('statechange', () => {
                            if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                showUpdateBanner(newWorker);
                            }
                        });
                    });
                } catch (error) {
                    console.error('âŒ Error registrando Service Worker:', error);
                }
            });
            
            navigator.serviceWorker.addEventListener('controllerchange', () => {
                //console.log('ðŸ”„ Nuevo Service Worker activado, recargando...');
                window.location.reload();
            });
        }
        
        if (window.matchMedia('(display-mode: standalone)').matches) {
            document.documentElement.setAttribute('data-pwa-installed', 'true');
            //console.log('ðŸ“± App ejecutÃ¡ndose como PWA instalada');
        }
    </script>
    <script src="/js/pwa-handler.js"></script>
    <script src="/js/app.js"></script>
</body>
</html>